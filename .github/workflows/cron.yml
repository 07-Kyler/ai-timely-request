name: AI News Daily Push

on:
  schedule:
    - cron: '0 1 * * *'   # 北京时间早9点
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch AI News RSS
        run: |
          curl -s https://www.theverge.com/rss/ai/artificial-intelligence/index.xml -o news.xml

      - name: Extract Titles
        run: |
          grep "<title>" news.xml | head -n 10 | sed 's/<[^>]*>//g' > titles.txt

      - name: Call Dragonfly API
        run: |
          CONTENT=$(cat titles.txt | tr '\n' ' ')

          RESPONSE=$(curl https://dragonfly-api.com/v1/chat/completions \
            -s \
            -H "Authorization: Bearer ${{ secrets.DRAGONFLY_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"deepseek/deepseek-chat\",
              \"messages\": [
                {\"role\":\"system\",\"content\":\"你是科技主编，请从以下AI新闻标题中筛选最重要的3条并简要总结\"},
                {\"role\":\"user\",\"content\":\"$CONTENT\"}
              ]
            }")

          echo "$RESPONSE" > result.json

      - name: Extract Text
        run: |
          TEXT=$(jq -r '.choices[0].message.content' result.json)
          echo "$TEXT" > final.txt

      - name: Send To Feishu
        run: |
          MESSAGE=$(cat final.txt | sed ':a;N;$!ba;s/\n/\\n/g')

          curl -X POST "Pq44yGSmRL6PyJrNDKV79gMMWeQmoGHO" \
            -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MESSAGE\"}}"
